import React, { createContext, useCallback, useContext, useMemo, useState } from "react";

const STORAGE_KEY = "renfe-ds-lang";

const STRINGS = {
  es: {
    appName: "Renfe",
    nav: {
      home: "Inicio",
      search: "Buscar",
      help: "Ayuda",
      access: "Accede",
      menu: "Menú",
      login: "Entrar",
      results: "Resultados",
      fares: "Tarifas",
      extras: "Extras",
      payment: "Pago",
    },
    common: {
      continue: "Continuar",
      back: "Volver",
      retry: "Reintentar",
      change: "Cambiar",
      accept: "Aceptar",
      loading: "Cargando",
      optional: "(opcional)",
      skipToContent: "Saltar al contenido",
      language: "Idioma",
    },
    home: {
      title: "Buscar viaje",
      origin: "Origen",
      destination: "Destino",
      dates: "Fechas",
      departDate: "Ida",
      returnDate: "Vuelta",
      tripType: "Tipo de viaje",
      oneWay: "Viaje solo ida",
      roundTrip: "Viaje de ida y vuelta",
      passengers: "Pasajeros",
      adults: "adulto",
      passengersAdults: "Adultos",
      passengersAdultsHelp: "Más de 13 años",
      passengersChildren: "Niños",
      passengersChildrenHelp: "De 0 a 13 años",
      passengersInfants: "Bebés / Niños",
      passengersInfantsHelp: "De 0 a 3 años gratis\nSin ocupar plaza",
      passengersCancel: "Cancelar",
      passengersApply: "Listo",
      weekDays: ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"],
      resetDates: "Restablecer",
      search: "Buscar",
      swap: "Intercambiar",
      stationValid: "Estación válida",
      dateAriaLabel: "Selecciona una fecha",
      openCalendar: "Abrir calendario",
      prevMonth: "Mes anterior",
      nextMonth: "Mes siguiente",
      dateInvalid: "Fecha no válida",
      dateIncomplete: "Fecha incompleta",
      dateRequired: "Indica una fecha",
      errors: {
        originRequired: "Indica un origen",
        destinationRequired: "Indica un destino",
        stationInvalid: "Selecciona una estación válida de la lista.",
      },
    },
    login: {
      title: "Entrar o crear cuenta",
      email: "Email",
      password: "Contraseña",
      submit: "Acceder",
    },
    results: {
      title: "Resultados",
      filters: "Filtros",
      journeys: "Trenes disponibles",
      select: "Elegir",
      selected: "Seleccionado",
      filterTime: "Horarios",
      filterPrice: "Precio",
      filterServices: "Servicios",
      priceFrom: "Desde",
      sortBy: "Ordenar por",
      sortPrice: "Precio más bajo",
      sortDeparture: "Salida más temprana",
      sortDuration: "Menor duración",
      modifySearch: "Modificar búsqueda",
      emptyTitle: "No hay trenes disponibles",
      emptyBody: "Prueba ajustando la búsqueda o relajando los filtros aplicados.",
      emptyAction1: "Relaja filtros o amplía la franja horaria.",
      emptyAction2: "Aumenta el precio máximo.",
      emptyAction3: "Cambia la fecha seleccionada.",
      direct: "Directo",
      transfers: "transbordos",
      connection: "Conexión",
      serviceWifi: "Wifi",
      servicePower: "Enchufe",
      serviceQuiet: "Silencio",
      serviceCafe: "Cafetería",
      accessSeat: "Plaza H",
      accessAssistance: "Asistencia",
      accessCompanion: "Acompañante",
      accessAdjacent: "Asiento contiguo",
      pet: "Mascota",
      moreFeatures: "Mostrar más características",
      updatedFor: "Resultados actualizados para",
      dayPickerLabel: "Seleccionar día",
      prevDays: "Días anteriores",
      nextDays: "Días siguientes",
      noAvailability: "Sin plazas",
      today: "Hoy",
      loadingDay: "Actualizando resultados",
    },
    filtersPanel: {
      title: "Filtros",
      clearAll: "Limpiar todo",
      applied: "Aplicados",
      updating: "Actualizando resultados…",
      sections: {
        flexibleDates: {
          title: "Fechas flexibles",
          toggle: "Ver precios y disponibilidad ±3 días",
          note: "Mantén filtros al cambiar de día.",
        },
        pets: {
          title: "Mascotas",
          toggle: "Viajar con mascota",
          note: "Filtra trenes realmente pet-friendly.",
          typesLabel: "Tipo",
          typeDog: "Perro",
          typeCat: "Gato",
          typeOther: "Otros",
          sizesLabel: "Tamaño / peso",
          sizeSmall: "<10 kg (transportín)",
          sizeMedium: "10–40 kg (plaza)",
          sizeLarge: ">40 kg",
          onlyAllowed: "Solo mostrar trenes donde se permita",
          rulesLink: "Ver reglas por tren/tarifa",
        },
        connections: {
          title: "Enlaces y trasbordos",
          note: "Controla conexiones y tiempos mínimos.",
          directOnly: "Solo directos",
          maxTransfers: "Máx. trasbordos",
          transfer0: "0",
          transfer1: "1",
          transfer2: "2",
          minConnection: "Tiempo mínimo de conexión",
          conn10: "10 min",
          conn20: "20 min",
          conn30: "30 min",
        },
        price: {
          title: "Precio",
          note: "Define un tope para el precio base.",
          maxPrice: "Precio máximo",
          showFinal: "Mostrar precio final estimado (incl. extras)",
        },
        fare: {
          title: "Condiciones de tarifa",
          note: "Evita ambigüedad en cambios y reembolsos.",
          refundable: "Reembolsable",
          changes: "Permite cambios",
          seat: "Incluye selección de asiento",
          baggage: "Equipaje incluido",
        },
        time: {
          title: "Franja horaria",
          note: "Usa presets o define rangos.",
          morning: "Mañana",
          afternoon: "Tarde",
          night: "Noche",
          departRange: "Salida entre",
          arriveRange: "Llegada entre",
          from: "Desde",
          to: "Hasta",
        },
        duration: {
          title: "Duración",
          note: "Limita la duración total del viaje.",
          maxDuration: "Duración máxima",
          d2: "< 2h",
          d3: "< 3h",
          d4: "< 4h",
        },
        accessibility: {
          title: "Accesibilidad",
          note: "Opciones de viaje accesible.",
          seat: "Plaza H disponible",
          assistance: "Necesito asistencia",
          companion: "Viajo con acompañante",
          adjacent: "Asiento contiguo",
          prioritizeTransfers: "Priorizar rutas con menos trasbordos",
        },
        onboard: {
          title: "Servicios a bordo",
          note: "Servicios disponibles en el tren.",
          wifi: "Wifi",
          power: "Enchufe",
          quiet: "Silencio",
          cafe: "Cafetería",
        },
        train: {
          title: "Tipo de tren y estación",
          note: "Filtra por tipo u opciones alternativas.",
          ave: "AVE",
          avlo: "AVLO",
          alvia: "Alvia",
          md: "Media Distancia",
          altStations: "Estaciones alternativas cercanas",
        },
      },
    },
    fares: {
      title: "Tarifas",
      compare: "Comparar tarifas",
      select: "Elegir tarifa",
      tableFare: "Tarifa",
      tableConditions: "Condiciones",
      tablePrice: "Precio",
      tableAction: "Acción",
    },
    extras: {
      title: "Extras",
      select: "Añadir extras",
      added: "Añadido",
    },
    payment: {
      title: "Pago",
      pay: "Confirmar pago",
      errorTitle: "No se pudo completar el pago",
      errorBody: "Ha ocurrido un error temporal. Puedes reintentar o volver atrás sin perder tu selección.",
      name: "Nombre",
      cardNumber: "Número de tarjeta",
      expiry: "Caducidad",
      cvv: "CVV",
      changeBody: "Cambia el método de pago sin perder tu selección.",
      accept: "Aceptar",
    },
    summary: {
      title: "Resumen",
      journey: "Trayecto",
      fare: "Tarifa",
      extras: "Extras",
      total: "Total",
      priceUpdated: "Precio actualizado",
      pending: "Pendiente",
      selectJourneyHelper: "Selecciona un tren para continuar",
    },
    stepper: {
      results: "Resultados",
      fares: "Tarifas",
      extras: "Extras",
      payment: "Pago",
    },
    tabs: {
      sevenDays: "7 días",
    },
    drawer: {
      menuTitle: "Menú",
      navigation: "Navegación",
      searchLabel: "Buscar",
      searchPlaceholder: "Buscar",
      cercanias: "Cercanías",
      viaja: "Viaja",
      sortBy: "Sort by",
      sortPrice: "Lowest price",
      sortDeparture: "Earliest departure",
      sortDuration: "Shortest duration",
      modifySearch: "Edit search",
      emptyTitle: "No trains available",
      emptyBody: "Try adjusting your search or relaxing the filters.",
      emptyAction1: "Relax filters or expand the time range.",
      emptyAction2: "Increase the max price.",
      emptyAction3: "Change the selected date.",
      direct: "Direct",
      transfers: "transfers",
      connection: "Connection",
      serviceWifi: "Wifi",
      servicePower: "Power",
      serviceQuiet: "Quiet",
      serviceCafe: "Cafe",
      accessSeat: "Accessible seat",
      accessAssistance: "Assistance",
      accessCompanion: "Companion",
      accessAdjacent: "Adjacent seat",
      inspira: "Inspírate",
      manageTicket: "Gestiona tu billete",
      moreRenfe: "Más Renfe",
      help: "Ayuda y contacto",
      access: "Acceso",
      settings: "Ajustes",
      language: "Idioma",
      cookies: "Galletas",
      cookiesMvp: "Gestión de cookies (MVP)",
      darkMode: "Modo oscuro",
      modeOn: "Modo oscuro activado",
      modeOff: "Modo oscuro desactivado",
    },
    navSearch: {
      title: "Buscar en la web",
      subtitle: "Encuentra páginas, ayuda o productos.",
      placeholder: "Escribe tu búsqueda",
      suggestionsLabel: "Busquedas frecuentes",
      close: "Cerrar",
      suggestions: [
        "Solicitud de reembolso",
        "Horarios online",
        "Billetes supersaver",
        "Swiss Travel Pass",
        "Saver Day Pass",
        "Half Fare Travelcard",
        "Half Fare Travelcard PLUS",
        "Interrail",
        "Bicicleta",
      ],
    },
  },
  en: {
    appName: "Renfe",
    nav: {
      home: "Home",
      search: "Search",
      help: "Help",
      access: "Sign in",
      menu: "Menu",
      login: "Sign in",
      results: "Results",
      fares: "Fares",
      extras: "Extras",
      payment: "Payment",
    },
    common: {
      continue: "Continue",
      back: "Back",
      retry: "Retry",
      change: "Change",
      accept: "Accept",
      loading: "Loading",
      optional: "(optional)",
      skipToContent: "Skip to content",
      language: "Language",
    },
    home: {
      title: "Search trip",
      origin: "Origin",
      destination: "Destination",
      dates: "Dates",
      departDate: "Departure",
      returnDate: "Return",
      tripType: "Trip type",
      oneWay: "One way",
      roundTrip: "Round trip",
      passengers: "Passengers",
      adults: "adult",
      passengersAdults: "Adults",
      passengersAdultsHelp: "Over 13 years",
      passengersChildren: "Children",
      passengersChildrenHelp: "Ages 0 to 13",
      passengersInfants: "Infants / Children",
      passengersInfantsHelp: "Ages 0 to 3 free\nNo seat",
      passengersCancel: "Cancel",
      passengersApply: "Done",
      weekDays: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
      resetDates: "Reset",
      search: "Search",
      swap: "Swap",
      stationValid: "Valid station",
      dateAriaLabel: "Select a date",
      openCalendar: "Open calendar",
      prevMonth: "Previous month",
      nextMonth: "Next month",
      dateInvalid: "Invalid date",
      dateIncomplete: "Incomplete date",
      dateRequired: "Select a date",
      errors: {
        originRequired: "Enter an origin",
        destinationRequired: "Enter a destination",
        stationInvalid: "Select a valid station from the list.",
      },
    },
    login: {
      title: "Sign in or create account",
      email: "Email",
      password: "Password",
      submit: "Sign in",
    },
    results: {
      title: "Results",
      filters: "Filters",
      journeys: "Available trains",
      select: "Select",
      selected: "Selected",
      filterTime: "Times",
      filterPrice: "Price",
      filterServices: "Services",
      priceFrom: "From",
      pet: "Pet",
      moreFeatures: "Show more features",
      updatedFor: "Results updated for",
      dayPickerLabel: "Select day",
      prevDays: "Previous days",
      nextDays: "Next days",
      noAvailability: "No seats",
      today: "Today",
      loadingDay: "Updating results",
    },
    filtersPanel: {
      title: "Filters",
      clearAll: "Clear all",
      applied: "Applied",
      updating: "Updating results…",
      sections: {
        flexibleDates: {
          title: "Flexible dates",
          toggle: "See prices and availability ±3 days",
          note: "Keep filters when switching days.",
        },
        pets: {
          title: "Pets",
          toggle: "Travel with pet",
          note: "Filter truly pet-friendly trains.",
          typesLabel: "Type",
          typeDog: "Dog",
          typeCat: "Cat",
          typeOther: "Other",
          sizesLabel: "Size / weight",
          sizeSmall: "<10 kg (carrier)",
          sizeMedium: "10–40 kg (seat)",
          sizeLarge: ">40 kg",
          onlyAllowed: "Only show trains where it's allowed",
          rulesLink: "See rules by train/fare",
        },
        connections: {
          title: "Connections",
          note: "Control transfers and minimum times.",
          directOnly: "Direct only",
          maxTransfers: "Max transfers",
          transfer0: "0",
          transfer1: "1",
          transfer2: "2",
          minConnection: "Minimum connection time",
          conn10: "10 min",
          conn20: "20 min",
          conn30: "30 min",
        },
        price: {
          title: "Price",
          note: "Set a cap for the base price.",
          maxPrice: "Maximum price",
          showFinal: "Show estimated final price (incl. extras)",
        },
        fare: {
          title: "Fare conditions",
          note: "Decide with clear conditions.",
          refundable: "Refundable",
          changes: "Changes allowed",
          seat: "Seat selection included",
          baggage: "Baggage included",
        },
        time: {
          title: "Time window",
          note: "Use presets or set ranges.",
          morning: "Morning",
          afternoon: "Afternoon",
          night: "Night",
          departRange: "Departure between",
          arriveRange: "Arrival between",
          from: "From",
          to: "To",
        },
        duration: {
          title: "Duration",
          note: "Limit total trip duration.",
          maxDuration: "Max duration",
          d2: "< 2h",
          d3: "< 3h",
          d4: "< 4h",
        },
        accessibility: {
          title: "Accessibility",
          note: "Accessible travel options.",
          seat: "Accessible seat (H)",
          assistance: "I need assistance",
          companion: "Traveling with companion",
          adjacent: "Adjacent seat",
          prioritizeTransfers: "Prioritize fewer transfers",
        },
        onboard: {
          title: "Onboard services",
          note: "Services available on train.",
          wifi: "Wifi",
          power: "Power outlet",
          quiet: "Quiet car",
          cafe: "Cafeteria",
        },
        train: {
          title: "Train type & station",
          note: "Filter by type or alternatives.",
          ave: "AVE",
          avlo: "AVLO",
          alvia: "Alvia",
          md: "Regional",
          altStations: "Nearby alternative stations",
        },
      },
    },
    fares: {
      title: "Fares",
      compare: "Compare fares",
      select: "Select fare",
      tableFare: "Fare",
      tableConditions: "Conditions",
      tablePrice: "Price",
      tableAction: "Action",
    },
    extras: {
      title: "Extras",
      select: "Add extras",
      added: "Added",
    },
    payment: {
      title: "Payment",
      pay: "Confirm payment",
      errorTitle: "Payment could not be completed",
      errorBody: "A temporary error occurred. You can retry or go back without losing your selection.",
      name: "Name",
      cardNumber: "Card number",
      expiry: "Expiry",
      cvv: "CVV",
      changeBody: "Change the payment method without losing your selection.",
      accept: "Accept",
    },
    summary: {
      title: "Summary",
      journey: "Journey",
      fare: "Fare",
      extras: "Extras",
      total: "Total",
      priceUpdated: "Price updated",
      pending: "Pending",
      selectJourneyHelper: "Select a train to continue",
    },
    stepper: {
      results: "Results",
      fares: "Fares",
      extras: "Extras",
      payment: "Payment",
    },
    tabs: {
      sevenDays: "7 days",
    },
    drawer: {
      menuTitle: "Menu",
      navigation: "Navigation",
      searchLabel: "Search",
      searchPlaceholder: "Search",
      cercanias: "Cercanías",
      viaja: "Travel",
      inspira: "Get inspired",
      manageTicket: "Manage your ticket",
      moreRenfe: "More Renfe",
      help: "Help and contact",
      access: "Access",
      settings: "Settings",
      language: "Language",
      cookies: "Cookies",
      cookiesMvp: "Cookie management (MVP)",
      darkMode: "Dark mode",
      modeOn: "Dark mode enabled",
      modeOff: "Dark mode disabled",
    },
    navSearch: {
      title: "Search the site",
      subtitle: "Find pages, help, or products.",
      placeholder: "Enter search term",
      suggestionsLabel: "Often searched",
      close: "Close",
      suggestions: [
        "Refund request",
        "Online timetable",
        "Supersaver tickets",
        "Swiss Travel Pass",
        "Saver Day Pass",
        "Half Fare Travelcard",
        "Half Fare Travelcard PLUS",
        "Interrail",
        "Bike",
      ],
    },
  },
};

const I18nContext = createContext(null);

export function I18nProvider({ children }) {
  const [language, setLanguage] = useState(() => {
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored && STRINGS[stored] ? stored : "es";
  });

  const setLang = useCallback((lang) => {
    if (!STRINGS[lang]) return;
    setLanguage(lang);
    localStorage.setItem(STORAGE_KEY, lang);
  }, []);

  const t = useCallback(
    (key) => {
      const parts = key.split(".");
      let current = STRINGS[language];
      for (const part of parts) {
        current = current?.[part];
      }
      return current ?? key;
    },
    [language]
  );

  const value = useMemo(
    () => ({ language, setLanguage: setLang, t }),
    [language, setLang, t]
  );

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) {
    throw new Error("useI18n must be used within I18nProvider");
  }
  return ctx;
}
